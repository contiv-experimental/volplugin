---
# This role contains tasks for configuring and starting docker service

- name: create docker daemon's config directory
  file: path=/etc/systemd/system/docker.service.d state=directory

- name: setup docker daemon's environment
  template: src=env.conf.j2 dest=/etc/systemd/system/docker.service.d/env.conf
  register: docker_env_conf_result

- name: copy systemd units for docker(enable cluster store)
  template: src=docker-svc.j2 dest=/lib/systemd/system/docker.service
  register: docker_svc_conf_result

- name: copy systemd units for docker tcp socket settings
  template: src=docker-tcp.j2 dest=/etc/systemd/system/docker-tcp.socket
  register: docker_tcp_conf_result

- name: remove the docker key file, if any. It shall be regenerated by docker on restart
  file: name=/etc/docker/key.json  state=absent
  when: docker_env_conf_result.changed or docker_tcp_conf_result.changed

- name: restart docker
  shell: systemctl daemon-reload && systemctl stop docker && systemctl start docker-tcp.socket && systemctl start docker
  when: docker_env_conf_result.changed or docker_tcp_conf_result.changed or docker_svc_conf_result.changed

#NOTE: Without this step, pip crashes after installing docker-py/docker-compose
#      Move to appropriate role later
- name: upgrade pip
  pip:
    name: pip
    extra_args: "--upgrade"

- name: install docker-py
  pip: name=docker-py

- name: install docker-compose
  pip: name=docker-compose state=latest extra_args=--upgrade
